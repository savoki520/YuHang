<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>常州-宇航</title>
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/index.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../lib/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="../../css/icon/font-awesome.min.css">
    <link rel="stylesheet" href="../../css/three-bounce.css">
</head>
<body style="padding: 156px 0 0 343px">
<!--头部-->
<header class="index-header">
    <div class="header-top"></div>
    <div class="header-middle clearfix">
        <div class="logo pull-left">
            <img src="../../images/index/head-logo.png" alt="">
        </div>
        <div class="content pull-right clearfix">
            <div class="set pull-right" id="exit-System">
                <img src="../../images/index/header-exit.png" alt="">
            </div>
            <div class="set pull-right" id="change-Password">
                <img src="../../images/index/header-set.png" alt="">
            </div>
            <div class="set pull-right" id="lock-screen">
                <img src="../../images/index/header-lock.png" alt="">
            </div>
            <div class="line pull-right"></div>
            <div class="box pull-right">
                <img src="../../images/index/header-time.png" alt="">
                <span id="dataTime">2018年12月26日 星期三</span>
            </div>
            <div class="box pull-right">
                <img src="../../images/index/header-person.png" alt="">
                <span id="username">张海华，欢迎您</span>
            </div>
        </div>
    </div>
    <div class="header-bottom clearfix">
        <div class="title pull-left" id="pageTitle">
            项目进度
        </div>
        <div class=" content pull-right clearfix">
            <div class="department pull-right">
                <img src="../../images/index/work_icon.png" alt="">
                <span>设计部</span>
            </div>
            <div class="search pull-right">
                <input type="text" name="search">
                <img src="../../images/index/header-search.png" alt="" id="file-search">
            </div>
        </div>
    </div>
</header>
<aside class="index-menu">
    <div class="title">
        <img src="../../images/menu/menu8.png" alt="">
        <span>个人工作台</span>
    </div>
    <div class="menu active">
        <a href="../../index.html">
            <img src="../../images/menu/menu1-1.png" alt="">
            <span>项目查看</span>
        </a>
    </div>
    <div class="menu">
        <a href="ProjectProgress.html">
            <img src="../../images/menu/menu2.png" alt="">
            <span>项目进度</span>
        </a>
    </div>
    <div class="menu" style="margin-top: 0;">
        <a href="PaymentInspection.html">
            <img src="../../images/menu/menu3.png" alt="">
            <span>付款及报验</span>
        </a>
    </div>
    <div class="menu" style="margin-top: 0;">
        <a href="CreditDocument.html">
            <img src="../../images/menu/menu4.png" alt="">
            <span>资信文件</span>
        </a>
    </div>
    <div class="menu" style="margin-top: 0;">
        <a href="ExcellentProject.html">
            <img src="../../images/menu/menu5.png" alt="">
            <span>优秀项目</span>
        </a>
    </div>
    <div class="menu" style="margin-top: 0;">
        <a href="Reimburse.html">
            <img src="../../images/menu/menu6.png" alt="">
            <span>报销</span>
        </a>
    </div>
    <div class="menu" style="margin-top: 0;">
        <a href="RecycleBin.html">
            <img src="../../images/menu/menu7.png" alt="">
            <span>回收站</span>
        </a>
    </div>
</aside>
<section class="index-content-detail">
    <div class="title">
        <a style="margin-left: 24px;" href="../../index.html"><img src="../../images/design/mulu.png" alt=""></a>
        <span id="TimeSorting">时间排序</span>
        <img src="../../images/design/icon1.png" alt="">
        <div class="upload">
            <img src="../../images/design/icon3.png" alt="">
            <span>上传</span>
            <input type="file" id="upload">
        </div>
    </div>
    <div class="content" id="project-detail-content">
        <div class="clearfix" id="Fixed-file">

        </div>
        <div class="clearfix" id="Moving-file">

        </div>
    </div>
    <div class="addNew" id="project-detail-addnew">
        <img src="../../images/design/pic2.png" alt="">
        <span>新建文件</span>
    </div>
</section>
<section class="index-progress">
    <div class="title">
        <span>项目点亮</span>
    </div>
    <div class="content">
        <div class="progress clearfix">
            <div class="number clearfix pull-left">
                <div class="pull-left">
                    <i class="fa fa-list"></i>
                    <span id="name">编号：001</span>
                </div>
                <div class="pull-left">
                    <i class="fa fa-clock-o"></i>
                    <span style="font-family:Microsoft YaHei;" id="time">2018/5/12</span>
                </div>
            </div>
            <div class="people pull-left" id="leader">
                <img src="../../images/design/icon2.png" alt="">
                <p>张三</p>
                <p>李四</p>
                <p>王二</p>
            </div>
            <div class="chart pull-left clearfix">
                <div class="style pull-left" data-st="st1" data-img="../../images/design/img1-2.png">
                    <img src="../../images/design/img1.png" alt="">
                    <p>开始项目</p>
                </div>
                <div class="style2 pull-left">
                    <span class="line"></span>
                </div>
                <div class="style pull-left" data-st="st2" data-img="../../images/design/img2-2.png">
                    <img src="../../images/design/img2.png" alt="">
                    <p>图纸深化</p>
                </div>
                <div class="style2 pull-left">
                    <span class="line"></span>
                </div>
                <div class="style pull-left" data-st="st3" data-img="../../images/design/img3-2.png">
                    <img src="../../images/design/img3.png" alt="">
                    <p>施工图纸</p>
                </div>
                <div class="style3 pull-left clearfix">
                    <span class="line pull-left"></span>
                    <div class="line2 pull-left">
                        <div class="style4" data-st="st4" data-img="../../images/design/img4-2.png">
                            <img src="../../images/design/img4.png" alt="">
                            <span>工程部</span>
                        </div>
                        <div class="style5" data-st="st5" data-img="../../images/design/img5-2.png">
                            <img src="../../images/design/img5.png" alt="">
                            <span>生产部</span>
                        </div>
                    </div>
                    <span class="line pull-left"></span>
                </div>
                <div class="style pull-left" style="width: 88px" data-st="st6" data-img="../../images/design/img6-2.png">
                    <img src="../../images/design/img3.png" alt="">
                    <p>甲方变更汇总</p>
                </div>
                <div class="style2 pull-left">
                    <span class="line"></span>
                </div>
                <div class="style pull-left" data-st="st7" data-img="../../images/design/img7-2.png">
                    <img src="../../images/design/img7.png" alt="">
                    <p>竣工图纸</p>
                </div>
                <div class="style2 pull-left">
                    <span class="line"></span>
                </div>
                <div class="style pull-left" data-st="st8" data-img="../../images/design/img8-2.png">
                    <img src="../../images/design/img8.png" alt="">
                    <p>完成</p>
                </div>
            </div>
        </div>
    </div>
</section>
<!--loading-->
<div class="sk-three-bounce" id="loading">
    <div class="sk-child sk-bounce1"></div>
    <div class="sk-child sk-bounce2"></div>
    <div class="sk-child sk-bounce3"></div>
</div>
<!--新建文件夹-->
<div id="project-detail-new-folder" class="add-common-folder">
    <div class="content">
        <p class="title">新建文件夹</p>
        <div class="input">
            <p>文件夹名称</p>
            <input type="text" name="folderName">
        </div>
        <div>
            <span id="project-detail-addCancel" class="btn btn-default cancel">取消</span>
            <span id="project-detail-addOk" class="btn btn-primary ok">确定</span>
        </div>
    </div>
</div>
<!--重命名-->
<div id="rename-folder" class="add-common-folder">
    <div class="content">
        <p class="title">项目重命名</p>
        <div class="input">
            <p>名称</p>
            <input type="text" name="rename-folder">
        </div>
        <div>
            <span id="rename-folder-Cancel" class="btn btn-default cancel">取消</span>
            <span id="rename-folder-Ok" class="btn btn-primary ok">确定</span>
        </div>
    </div>
</div>
<!--锁屏-->
<div id="lock-enter">
    <div class="content">
        <p class="title">提示<i class="fa fa-exclamation-circle"></i></p>
        <div class="input">
            <div>
                <img src="../../images/index/lock-enter.png" alt="">
            </div>
            <div>
                <input type="password" name="lock" class="text-center" placeholder="请输入登录密码">
            </div>
            <div style="margin-top: 60px;">
                <span id="lock-enter-Cancel" class="btn btn-default cancel">重置</span>
                <span id="lock-enter-Ok" class="btn btn-primary ok">确定</span>
            </div>
        </div>
    </div>
</div>
<!--退出系统提示提示-->
<div id="exit-content" class="clear-worning">
    <div class="content">
        <p class="title">
            提示
            <i class="fa fa-exclamation-circle"></i>
        </p>
        <div class="warning text-center" style="font-weight: 700;">
            确认退出系统?
        </div>
        <div class="clear-btn">
            <span id="exit-cancel" class="btn btn-default">取消</span>
            <span id="exit-ok" class="btn btn-primary">确认 </span>
        </div>
    </div>
</div>
<script src="../../../Tool/js/jquery.min.js"></script>
<script src="../../lib/slimescroll/jquery.slimscroll.min.js"></script>
<script src="../../lib/js/toolsFun.js"></script>
<script>
    var argsFromPage;
    window.onload = function(){
        argsFromPage = args();
        console.log(argsFromPage);
        $('#loading').show();
        $('#pageTitle').empty();
        $('#pageTitle').append(argsFromPage.filePath);
        var json={
            "filePath":argsFromPage.filePath,
            "department":0
        };
        http('http://www.youguangchina.cn/YuHang/project/getListFiles','POST',json).done(function (res) {
            var data=res.files;
            var currentPath=res.currentPath;
            if(data.length>0){
                for(var i=0;i<data.length;i++){
                    var fileName="";
                    if(data[i].fileName.length>10)
                    {
                        fileName=data[i].fileName.substring(0,4) + "...";
                    }
                    else {
                        fileName=data[i].fileName;
                    }
                    if(data[i].fileName=="工程部"){
                        $(folder.getEngineering(i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Fixed-file"));
                        $('#file'+i).click(function(){
                            folder.getDClick(this);
                            event.stopPropagation();
                        });
                    }
                    else if(data[i].fileName=="生产部"){
                        $(folder.getProduction(i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Fixed-file"));
                        $('#file'+i).click(function(){
                            folder.getDClick(this);
                            event.stopPropagation();
                        });
                    }
                    else {
                        if(data[i].fileType=="directory"){
                            $(folder.getNew(currentPath,i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Moving-file"));
                            $('#file'+i).click(function(){
                                folder.getDClick(this);
                                event.stopPropagation();
                            });
                        }
                        else {
                            $(folder.getNew(currentPath,i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,data[i].url)).appendTo($("#Moving-file"));
                            $('#file'+i).click(function(){
                                folder.getFClick(this);
                                event.stopPropagation();
                            });
                        }

                    }
                }
            }
            else {
                alert(res.error);
            }
        }).fail(function() {
            alert('网络请求错误，请联系管理员！');
        });
        $.ajax({
            url:'http://www.youguangchina.cn/YuHang/progress/getOneProgress',
            type:'POST',
            data:"project_name="+argsFromPage.fileName,
            success:function (res) {
                var data=res.progress[0];
                $('#name').empty();
                $('#name').append("名称："+data.project_name);
                $('#time').empty();
                $('#time').append(data.beginTime);
                $("#leader").empty();
                var html='<img src="../../images/design/icon2.png" alt="">';
                for(var i=0;i<data.Leader.length;i++){
                    html+="<p>"+data.Leader[i].leader_name+"</p>";
                }
                $('#leader').append(html);
                for(var j=1;j<9;j++){
                    var str="st"+j;
                    var module=data.Progress[0][str];
                    if(module=='1'){
                        var img2=$("div[data-st="+str+"]").attr('data-img');
                        $("div[data-st="+str+"]").children('img').attr('src',img2);
                        $("div[data-st="+str+"]").css('color','#5584EA');
                    }
                }
                $('#loading').hide();
            },
            error:function () {
                alert("获取进度信息失败，请检查网络！");
            }
        });
    };


    //更新进度
    $("div[data-st]").on('click',function () {
        $('#loading').show();
        var $this=$(this);
        var json={
            "project_name":argsFromPage.fileName,
            "st_name":$this.attr('data-st'),
            "status":1
        };
        http('http://www.youguangchina.cn/YuHang/progress/changeStatus','POST',json).done(function (res) {
            if(res.result=="success"){
                $this.children('img').attr('src',$this.attr('data-img'));
                $this.css('color','#5584EA');
            }
            else {
                alert('进度更新失败，请检查网络！');
            }
            $('#loading').hide();
        }).fail(function() {
            alert('网络请求错误，请联系管理员！');
        });
    });


    //上传文件
    $('#upload').on('change',function () {
        $('#loading').show();
        var form = new FormData();
        var fileName=$(this).get(0).files[0];
        form.append("file", fileName);
        form.append("filePath",argsFromPage.filePath);
        var settings = {
            "async": true,
            "crossDomain": true,
            "url": "http://www.youguangchina.cn/YuHang/file/upload",
            "method": "POST",
            "processData": false,
            "contentType": false,
            "mimeType": "multipart/form-data",
            "data": form
        };
        $.ajax(settings).done(function (res) {
            $('#loading').hide();
            location.reload();
        });
    });


    //时间排序
    $('#TimeSorting').on('click',function () {
        $('#loading').show();
        $('#Fixed-file').empty();
        $('#Moving-file').empty();
        var json={
            "filePath":argsFromPage.filePath,
            "department":0
        };
        http('http://www.youguangchina.cn/YuHang/project/getListFilesByTime','POST',json).done(function (res) {
            var data=res.files;
            var currentPath=res.currentPath;
            if(data.length>0){
                for(var i=0;i<data.length;i++){
                    var fileName="";
                    if(data[i].fileName.length>10)
                    {
                        fileName=data[i].fileName.substring(0,4) + "...";
                    }
                    else {
                        fileName=data[i].fileName;
                    }
                    if(data[i].fileName=="工程部"){
                        $(folder.getEngineering(i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Fixed-file"));
                        $('#file'+i).click(function(){
                            folder.getDClick(this);
                            event.stopPropagation();
                        });
                    }
                    else if(data[i].fileName=="生产部"){
                        $(folder.getProduction(i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Fixed-file"));
                        $('#file'+i).click(function(){
                            folder.getDClick(this);
                            event.stopPropagation();
                        });
                    }
                    else {
                        if(data[i].fileType=="directory"){
                            $(folder.getNew(currentPath,i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Moving-file"));
                            $('#file'+i).click(function(){
                                folder.getDClick(this);
                                event.stopPropagation();
                            });
                        }
                        else {
                            $(folder.getNew(currentPath,i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,data[i].url)).appendTo($("#Moving-file"));
                            $('#file'+i).click(function(){
                                folder.getFClick(this);
                                event.stopPropagation();
                            });
                        }

                    }
                }
            }
            else {
                alert(res.error);
            }
            $('#loading').hide();
        }).fail(function() {
            alert('网络请求错误，请联系管理员！');
        });
    });


    //搜索
    $('#file-search').on('click',function () {
        $('#loading').show();
        $('#Fixed-file').empty();
        $('#Moving-file').empty();
        var json={
            "filePath":argsFromPage.filePath,
            "fileName":$("input[name='search']").val()
        };
        http('http://www.youguangchina.cn/YuHang/project/searchByFileName','POST',json).done(function (res) {
            var data=res.files;
            for(var i=0;i<data.length;i++){
                var currentPath=data[i].parentPath;
                var fileName="";
                if(data[i].fileName.length>10)
                {
                    fileName=data[i].fileName.substring(0,4) + "...";
                }
                else {
                    fileName=data[i].fileName;
                }
                if(data[i].fileName=="工程部"){
                    $(folder.getEngineering(i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Fixed-file"));
                    $('#file'+i).click(function(){
                        folder.getDClick(this);
                        event.stopPropagation();
                    });
                }
                else if(data[i].fileName=="生产部"){
                    $(folder.getProduction(i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Fixed-file"));
                    $('#file'+i).click(function(){
                        folder.getDClick(this);
                        event.stopPropagation();
                    });
                }
                else {
                    if(data[i].fileType=="directory"){
                        console.log("1");
                        $(folder.getNew(currentPath,i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,'')).appendTo($("#Moving-file"));
                        $('#file'+i).click(function(){
                            folder.getDClick(this);
                            event.stopPropagation();
                        });
                    }
                    else {
                        $(folder.getNew(currentPath,i,fileName,data[i].fileName,data[i].filePath,data[i].fileType,data[i].url)).appendTo($("#Moving-file"));
                        $('#file'+i).click(function(){
                            folder.getFClick(this);
                            event.stopPropagation();
                        });
                    }

                }
            }

            $('#loading').hide();
        }).fail(function() {
            alert('网络请求错误，请联系管理员！');
        });
    });



    //新建文件夹
    $('#project-detail-addnew').on('click',function () {
        $('#project-detail-new-folder').show();
    });
    $('#project-detail-addCancel').on('click',function () {
        $('#project-detail-new-folder').hide();
    });
    $('#project-detail-addOk').on('click',function () {
        if($("input[name='folderName']").val()==""){
            alert("文件夹名称不能为空！");
            return;
        }
        $('#loading').show();
        $.ajax({
            url: 'http://www.youguangchina.cn/YuHang/file/newFile',
            type: 'POST',
            data: "filePath="+ argsFromPage.filePath+"&fileName="+$("input[name='folderName']").val(),
            success:function (res) {
                if(res.result=="success"){
                    location.reload();
                }
                else {
                    alert("创建失败，请查看网络连接！");
                }
                $('#loading').hide();
            },
            fail:function () {
                alert('网络请求错误，请联系管理员！');
            }
        });
    })
</script>
</body>
</html>